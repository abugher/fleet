---
- hosts:                neuron
  name:                 'configure tftpd-hpa on neuron'
  gather_facts:         False
  remote_user:          ansible
  become:               yes
  become_method:        sudo
  tasks:

  - name:               'defaults file'
    copy:
      src:              '~/code/fleet/conf/tftpd-hpa/neuron/default.txt'
      dest:             '/etc/default/tftpd-hpa'
      owner:            'root'
      group:            'root'
      mode:             '0644'
    register:           neuron_tftp_defaults
  - name:               'restart service'
    service:
      name:             'tftpd-hpa'
      state:            'restarted'
    when:               neuron_tftp_defaults.changed
  - name:               'directories'
    file:
      path:             "{{ item }}"
      state:            'directory'
      owner:            'root'
      group:            'root'
      mode:             '0755'
    with_items:
      - '/srv/tftp/pxelinux.cfg'
      - '/srv/tftp/debian-installer'
      - '/srv/tftp/debian-installer/amd64'
      - '/srv/tftp/debian-installer/i386'
      - '/srv/tftp/debian-live/amd64/tftpboot'
      - '/srv/tftp/debian-live/amd64/binary'
      - '/srv/tftp/debian-live/i386/tftpboot'
      - '/srv/tftp/debian-live/i386/binary'
      - '/srv/tftp/pxelinux'
  - name:               'symlink lpxelinux.0'
    file:
      src:              'pxelinux/lpxelinux.0'
      path:             '/srv/tftp/lpxelinux.0'
      state:            'link'
      owner:            'root'
      group:            'root'
  - name:               'symlink ldlinux.c32'
    file:
      src:              'debian-installer/i386/boot-screens/ldlinux.c32'
      path:             '/srv/tftp/ldlinux.c32'
      state:            'link'
      owner:            'root'
      group:            'root'  
  - name:               'main menu'
    copy:
      src:              "~/code/fleet/conf/tftpd-hpa/neuron/pxelinux.cfg/{{ item }}"
      dest:             "/srv/tftp/pxelinux.cfg/{{ item }}"
      owner:            'root'
      group:            'root'
      mode:             '0644'
    with_items:
      - 'default'

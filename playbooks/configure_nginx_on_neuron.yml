---
- hosts:                neuron
  name:                 'configure nginx on neuron'
  gather_facts:         False
  remote_user:          ansible
  become:               yes
  become_method:        sudo
  tasks:

  - name:               'install index.html'
    copy:
      owner:            'root'
      group:            'root'
      mode:             '0644'
      src:              '~/code/fleet/conf/nginx/neuron/index.html'
      dest:             '/usr/share/nginx/www/index.html'
  - name:               'create plaintext directory'
    file:
      path:             '/usr/share/nginx/www/plaintext'
      owner:            'root'
      group:            'root'
      mode:             '0755'
      state:            'directory'
  - name:               'install preseed.cfg'
    copy:
      owner:            'root'
      group:            'root'
      mode:             '0644'
      src:              '~/code/fleet/conf/nginx/neuron/preseed.cfg'
      dest:             '/usr/share/nginx/www/plaintext/preseed.cfg'
  - name:               'install nginx.conf'
    copy:
      owner:            'root'
      group:            'root'
      mode:             '0644'
      src:              '~/code/fleet/conf/nginx/neuron/nginx.conf'
      dest:             '/etc/nginx/nginx.conf'
    register:           neuron_nginx_nginx_conf 

  - name:               'sites-available'
    copy:
      owner:            'root'
      group:            'root'
      mode:             '0644'
      src:              "~/code/fleet/conf/nginx/neuron/{{ item }}"
      dest:             "/etc/nginx/sites-available/{{ item }}"
    with_items:
      - 'default'
      - 'default.ssl'
      - 'nagios'
      - 'nagios.ssl'
      - 'remote'
      - 'remote.ssl'
      - 'smokeping'
      - 'smokeping.ssl'
      - 'transmission'
      - 'transmission.ssl'
      - 'wiki'
      - 'wiki.ssl'
    register:           neuron_nginx_sites_available


  - name:               'sites-enabled'
    file:
      owner:            'root'
      group:            'root'
      mode:             '0644'
      src:              "/etc/nginx/sites-available/{{ item }}"
      path:             "/etc/nginx/sites-enabled/{{ item }}"
      state:            'link'
    with_items:
      - 'default'
      - 'default.ssl'
      - 'nagios'
      - 'nagios.ssl'
      - 'remote'
      - 'remote.ssl'
      - 'smokeping'
      - 'smokeping.ssl'
      - 'transmission'
      - 'transmission.ssl'
      - 'wiki'
      - 'wiki.ssl'
    register:           neuron_nginx_sites_enabled

  - name:               'install private directory'
    file:
      path:             '/usr/share/nginx/www/private'
      state:            'directory'
      mode:             '0750'
      owner:            'root'
      group:            'www-data'
  - name:               'symlink pictures'
    file:
      src:              '/storage/aaron-phone/live/legacy/DCIM/Camera'
      dest:             '/usr/share/nginx/www/private/pictures'
      state:            'link'
      owner:            'root'
      group:            'root'
      mode:             '0644'
      force:            'yes'

  - name:               'install htpasswd'
    copy:
      owner:            'root'
      group:            'www-data'
      mode:             '0640'
      src:              '~/code/sensitive/conf/nginx/neuron/htpasswd'
      dest:             '/etc/nginx/htpasswd'

  - name:               'SSL key'
    copy:
      owner:            'root'
      group:            'www-data'
      mode:             '0640'
      src:              '~/code/sensitive/conf/ssl/neuronpointer.net/key'
      dest:             '/etc/nginx/neuron.key'
    register:           neuron_nginx_ssl_key
  - name:               'SSL cert'
    copy:
      owner:            'root'
      group:            'www-data'
      mode:             '0640'
      src:              '~/code/fleet/conf/ssl/neuronpointer.net/cert'
      dest:             '/etc/nginx/neuron.crt'
    register:           neuron_nginx_ssl_cert
  - name:               'enable service'
    service:
      name:             'nginx'
      enabled:          'yes'
    register:           neuron_nginx_enabled
  - name:               'restart restart'
    service:
      name:             'nginx'
      state:            'restarted'
    when:               neuron_nginx_nginx_conf.changed
                        or neuron_nginx_sites_available.changed
                        or neuron_nginx_sites_enabled.changed 
                        or neuron_nginx_ssl_key.changed 
                        or neuron_nginx_ssl_cert.changed
                        or neuron_nginx_enabled.changed

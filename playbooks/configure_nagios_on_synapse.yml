---
- hosts:                synapse
  name:                 'configure nagios on synapse'
  gather_facts:         False
  remote_user:          ansible
  become:               yes
  become_method:        sudo
  tasks:

  # Work around bug in synchronize 2.0.0.
  - name:               'sync /etc/nagios3/'
    become:             'false'         # work-around
    synchronize:
      rsync_path:       'sudo rsync'    # work-around
      src:              '~/code/fleet/conf/nagios/synapse/nagios3/'
      dest:             '/etc/nagios3/'
      delete:           'yes'
    register:           nagios_config_synapse
  - name:               'install logos'
    copy:
      src:              '~/code/fleet/conf/nagios/synapse/logos/'
      dest:             '/usr/share/nagios3/htdocs/images/logos/custom/'
      owner:            'root'
      group:            'root'
  - name:               'install htpasswd.users'
    copy:
      src:              '~/code/sensitive/conf/nagios/synapse/nagios3/htpasswd.users'
      dest:             '/etc/nagios3/htpasswd.users'
      owner:            'root'
      group:            'root'
    register:           nagios_htpasswd_synapse
  - name:               'restart service'
    service:
      name:             'nagios3'
      state:            'restarted'
    when:               nagios_config_synapse.changed or nagios_htpasswd_synapse.changed


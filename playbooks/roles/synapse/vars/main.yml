---
install_packages:
  - 'nginx'
  - 'nginx-extras'
  - 'nagios3'
  - 'mini-httpd'                # for smokeping
  - 'libffi5-dev'
  - 'libxml2-dev'
  - 'krb5-admin-server'
  - 'krb5-kdc'
  - 'krb5-user'
  - 'fcgiwrap'
  - 'php5-fpm'
  - 'zabbix-server-mysql'       # for zabbix
  - 'zabbix-frontend-php'       # for zabbix
  - 'mysql-server'              # for zabbix
  - 'libmysqlclient-dev'        # for zabbix
install_files:
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/conf/apt/synapse/sources.list'
    dest:               '/etc/apt/sources.list'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/conf/apt/synapse/raspi.list'
    dest:               '/etc/apt/sources.list.d/raspi.list'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/conf/ansible/ansible.cfg'
    dest:               '/etc/ansible/ansible.cfg'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/conf/ansible/hosts'
    dest:               '/etc/ansible/hosts'
  - owner:              'root'
    group:              'root'
    mode:               '0600'
    src:                '~/code/sensitive/conf/ssh_keys/root@synapse.id_rsa'
    dest:               '/root/.ssh/id_rsa'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/conf/ssh_keys/root@synapse.id_rsa.pub'
    dest:               '/root/.ssh/id_rsa.pub'
  - owner:              'nagios'
    group:              'nagios'
    mode:               '0600'
    src:                '~/code/sensitive/conf/ssh_keys/nagios@synapse.id_rsa'
    dest:               '~nagios/.ssh/id_rsa'
  - owner:              'nagios'
    group:              'nagios'
    mode:               '0644'
    src:                '~/code/fleet/conf/ssh_keys/nagios@synapse.id_rsa.pub'
    dest:               '~nagios/.ssh/id_rsa.pub'
  - owner:              'nagios'
    group:              'nagios'
    mode:               '0600'
    src:                '~/code/fleet/conf/ssh_keys/nagios@synapse.known_hosts'
    dest:               '~nagios/.ssh/known_hosts'
  - owner:              'pi'
    group:              'pi'
    mode:               '0600'
    src:                '~/code/sensitive/conf/ssh_keys/pi@synapse.id_rsa'
    dest:               '~pi/.ssh/id_rsa'
  - owner:              'pi'
    group:              'pi'
    mode:               '0644'
    src:                '~/code/fleet/conf/ssh_keys/pi@synapse.id_rsa.pub'
    dest:               '~pi/.ssh/id_rsa.pub'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/cron.d/synapse/reboot'
    dest:               '/etc/cron.d/reboot'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/cron.d/synapse/update_debian'
    dest:               '/etc/cron.d/update_debian'
  - owner:              'root'
    group:              'root'
    mode:               '0755'
    src:                '~/code/fleet/bin/update_debian_now'
    dest:               '/usr/local/bin/update_debian_now'
  - owner:              'root'
    group:              'root'
    mode:               '0755'
    src:                '~/code/fleet/bin/update_debian_cronjob'
    dest:               '/usr/local/bin/update_debian_cronjob'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/conf/dphys-swapfile'
    dest:               '/etc/dphys-swapfile'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/conf/kerberos/kadm5.acl'
    dest:               '/etc/krb5kdc/kadm5.acl'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/conf/mini-httpd/synapse/mini-httpd.conf'
    dest:               '/etc/mini-httpd.conf'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/conf/mini-httpd/synapse/default.mini-httpd'
    dest:               '/etc/default/mini-httpd'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/conf/nagios/synapse/logos/'
    dest:               '/usr/share/nagios3/htdocs/images/logos/custom/'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/sensitive/conf/nagios/synapse/nagios3/htpasswd.users'
    dest:               '/etc/nagios3/htpasswd.users'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/conf/nginx/synapse/nginx.conf'
    dest:               '/etc/nginx/nginx.conf'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/conf/nginx/synapse/default'
    dest:               '/etc/nginx/sites-available/default'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/conf/nginx/synapse/default.ssl'
    dest:               '/etc/nginx/sites-available/default.ssl'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/conf/nginx/synapse/smokeping'
    dest:               '/etc/nginx/sites-available/smokeping'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/conf/nginx/synapse/nagios'
    dest:               '/etc/nginx/sites-available/nagios'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/conf/nginx/synapse/nagios.ssl'
    dest:               '/etc/nginx/sites-available/nagios.ssl'
  - owner:              'root'
    group:              'www-data'
    mode:               '0640'
    src:                '~/code/sensitive/conf/ssl/synapse/key.pem'
    dest:               '/etc/nginx/synapse.key'
  - owner:              'root'
    group:              'www-data'
    mode:               '0640'
    src:                '~/code/fleet/conf/ssl/synapse/chain.pem'
    dest:               '/etc/nginx/synapse.crt'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/conf/smokeping/synapse/Targets'
    dest:               '/etc/smokeping/config.d/Targets'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '~/code/fleet/cron.d/synapse/update_dns'
    dest:               '/etc/cron.d/update_dns'
symlinks:
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '/etc/nginx/sites-available/default'
    dest:               '/etc/nginx/sites-enabled/default'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '/etc/nginx/sites-available/default.ssl'
    dest:               '/etc/nginx/sites-enabled/default.ssl'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '/etc/nginx/sites-available/smokeping'
    dest:               '/etc/nginx/sites-enabled/smokeping'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '/etc/nginx/sites-available/nagios'
    dest:               '/etc/nginx/sites-enabled/nagios'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                '/etc/nginx/sites-available/nagios.ssl'
    dest:               '/etc/nginx/sites-enabled/nagios.ssl'
remove_files:
  - '/etc/apt/sources.list.d/collabora.list'
create_files:
  - path:               '/etc/ansible'
    state:              'directory'
    owner:              'root'
    group:              'root'
    mode:               '0755'
keys:
  - user:               'escrow'
    keyfile:            '~/code/fleet/conf/ssh_keys/root@neuron.id_rsa.pub'
  - user:               'pi'
    keyfile:            '~/code/fleet/conf/ssh_keys/aaron-phone@aaron-phone.id_rsa.pub'
restart_services:
  - 'dphys-swapfile'
  - 'mini-httpd'
  - 'nagios3'
  - 'nginx'
  - 'smokeping'
dot_users:
  - 'pi'
sync_dirs:
  - src:                '~/code/fleet/conf/nagios/synapse/nagios3/'
    dest:               '/etc/nagios3/'
    delete:             'yes'
stop_services:
  # Stop mini-httpd.  It errors on service start, otherwise.
  - 'mini-httpd'
enable_services:
  - 'nginx'
  - 'nagios3'
  - 'mini-httpd'

---
- hosts:                synapse
  gather_facts:         False
  remote_user:          ansible
  become:               yes
  become_method:        sudo
  tasks:
  - name:               'configure nginx on synapse:  nginx.conf'
    copy:
      owner:            'root'
      group:            'root'
      mode:             '0644'
      src:              '~/code/fleet/conf/nginx/synapse/nginx.conf'
      dest:             '/etc/nginx/nginx.conf'
    register:           synapse_nginx_conf

  - name:               'configure nginx on synapse, sites-available'
    copy:
      owner:            'root'
      group:            'root'
      mode:             '0644'
      src:              "~/code/fleet/conf/nginx/synapse/{{ item }}"
      dest:             "/etc/nginx/sites-available/{{ item }}"
    with_items:
      - 'default'
      - 'default.ssl'
      - 'smokeping'
      - 'nagios'
      - 'nagios.ssl'
    register:           synapse_nginx_sites_available

  - name:               'configure nginx on synapse, sites-enabled'
    file:
      owner:            'root'
      group:            'root'
      mode:             '0644'
      src:              "/etc/nginx/sites-available/{{ item }}"
      path:             "/etc/nginx/sites-enabled/{{ item }}"
      state:            'link'
    with_items:
      - 'default'
      - 'default.ssl'
      - 'smokeping'
      - 'nagios'
      - 'nagios.ssl'
    register:           synapse_nginx_sites_enabled

  - name:               'configure nginx on synapse, SSL key'
    copy:
      owner:            'root'
      group:            'www-data'
      mode:             '0640'
      src:              '~/code/sensitive/conf/ssl/synapse/synapse.key'
      dest:             '/etc/nginx/synapse.key'
  - name:               'configure nginx on synapse, SSL cert'
    copy:
      owner:            'root'
      group:            'www-data'
      mode:             '0640'
      src:              '~/code/fleet/conf/ssl/synapse/synapse.crt'
      dest:             '/etc/nginx/synapse.crt'
  - name:               'configure nginx on synapse, service restart'
    service:
      name:             'nginx'
      state:            'restarted'
    when:               synapse_nginx_conf.changed or synapse_nginx_sites_available.changed or synapse_nginx_sites_enabled.changed

---
- hosts:                synapse
  name:                 'configure nginx on synapse'
  gather_facts:         False
  remote_user:          ansible
  become:               yes
  become_method:        sudo
  tasks:

  - name:               'nginx.conf'
    copy:
      owner:            'root'
      group:            'root'
      mode:             '0644'
      src:              '~/code/fleet/conf/nginx/synapse/nginx.conf'
      dest:             '/etc/nginx/nginx.conf'
    register:           synapse_nginx_conf

  - name:               'sites-available'
    copy:
      owner:            'root'
      group:            'root'
      mode:             '0644'
      src:              "~/code/fleet/conf/nginx/synapse/{{ item }}"
      dest:             "/etc/nginx/sites-available/{{ item }}"
    with_items:
      - 'default'
      - 'default.ssl'
      - 'smokeping'
      - 'nagios'
      - 'nagios.ssl'
    register:           synapse_nginx_sites_available

  - name:               'sites-enabled'
    file:
      owner:            'root'
      group:            'root'
      mode:             '0644'
      src:              "/etc/nginx/sites-available/{{ item }}"
      path:             "/etc/nginx/sites-enabled/{{ item }}"
      state:            'link'
    with_items:
      - 'default'
      - 'default.ssl'
      - 'smokeping'
      - 'nagios'
      - 'nagios.ssl'
    register:           synapse_nginx_sites_enabled

  - name:               'SSL key'
    copy:
      owner:            'root'
      group:            'www-data'
      mode:             '0640'
      src:              '~/code/sensitive/conf/ssl/synapse/key.pem'
      dest:             '/etc/nginx/synapse.key'
    register:           synapse_nginx_ssl_key
  - name:               'SSL cert'
    copy:
      owner:            'root'
      group:            'www-data'
      mode:             '0640'
      src:              '~/code/fleet/conf/ssl/synapse/chain.pem'
      dest:             '/etc/nginx/synapse.crt'
    register:           synapse_nginx_ssl_cert
  - name:               'service restart'
    service:
      name:             'nginx'
      state:            'restarted'
    when:               synapse_nginx_conf.changed or synapse_nginx_sites_available.changed or synapse_nginx_sites_enabled.changed or synapse_nginx_ssl_key.changed or synapse_nginx_ssl_cert.changed

#!/bin/bash

# DISTRIBUTED BY ANSIBLE

# This program is free software. It comes without any warranty, to the extent
# permitted by applicable law. You can redistribute it and/or modify it under
# the terms of the Do What The Fuck You Want To Public License, Version 2, as
# published by Sam Hocevar. See WTFPL.txt or http://www.wtfpl.net/ for more
# details.


# Very system-specific script to mount the large storage volume.  Supply the
# pass phrase to stdin - it's pipe-able.

fail() {
  echo -e "ERROR: ${2}" >&2
  exit $1
}

ERR_LUKSOPEN=1
ERR_MOUNT=2
ERR_TRANS=3

{% if encrypted_storage is defined %}
{% for thing in encrypted_storage %}
/sbin/cryptsetup luksOpen "{{ thing.backing_device }}" "{{ thing.name }}" || fail $ERR_LUKSOPEN "Failed to luksOpen:  {{ thing.backing_device }} as {{ thing.name }}"
/bin/mount "/{{ thing.name }}" || fail $ERR_MOUNT "Failed to mount:  /{{ thing.name }}"

{% endfor %}
{% endif %}

if test -e /etc/init.d/transmission-daemon; then
  /usr/sbin/service transmission-daemon start || fail $ERR_TRANS "Failed to start service:  transmission-daemon"
fi
